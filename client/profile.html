<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>프로필 업데이트 • 귀농 청년</title>
  <link rel="stylesheet" href="profile.css" />
</head>
<body>
  <!-- 헤더 -->
  <header class="header">
    <a href="main.html" class="brand" aria-label="메인으로 이동">
      <div class="logo" aria-hidden="true">GN</div>
      <span>귀농 청년</span>
    </a>

    <div class="actions">
      <div id="avatar" class="avatar" tabindex="0" aria-haspopup="true" aria-expanded="false" title="프로필 및 설정">U</div>
      <nav id="menu" class="menu" aria-label="사용자 메뉴">
        <div class="email" id="userEmailLabel">로그인 정보 없음</div>
        <a href="profile.html">🧑‍🔧 프로필 업데이트</a>
        <a href="settings.html">⚙️ 설정</a>
        <a href="/logout" id="logoutLink">🚪 로그아웃</a>
      </nav>
    </div>
  </header>

  <!-- 메인 -->
  <main class="main">
    <section class="container" aria-labelledby="title">
      <div class="container__head">
        <h1 id="title">프로필 업데이트</h1>
        <p class="muted">
          내 환경을 알려주면 추천 작물·정책·일정을 더 정확하게 도와줄 수 있어요.
        </p>
      </div>

      <form id="profileForm" class="form" action="/profile/update" method="POST" novalidate>
        <!-- 1. 지역선택 -->
        <div class="field">
          <label for="region" class="label">지역선택 <span class="req">*</span></label>
          <div class="field__row">
            <select id="region" name="region" required>
              <option value="" selected disabled>시/도 선택</option>
              <option>서울특별시</option>
              <option>부산광역시</option>
              <option>대구광역시</option>
              <option>인천광역시</option>
              <option>광주광역시</option>
              <option>대전광역시</option>
              <option>울산광역시</option>
              <option>세종특별자치시</option>
              <option>경기도</option>
              <option>강원특별자치도</option>
              <option>충청북도</option>
              <option>충청남도</option>
              <option>전북특별자치도</option>
              <option>전라남도</option>
              <option>경상북도</option>
              <option>경상남도</option>
              <option>제주특별자치도</option>
            </select>

            <input id="region-detail" name="region_detail" type="text" inputmode="text"
                   placeholder="시/군/구, 읍/면/동 (선택)"
                   aria-label="세부 지역 (선택)" />
          </div>
          <p class="hint">예: 전북특별자치도 전주시 완산구</p>
        </div>

        <!-- 2. 토지규모 -->
        <div class="field">
          <label class="label">토지규모 <span class="req">*</span></label>
          <div class="field__row">
            <input id="land-size" name="land_size" type="number" min="0" step="0.01" required
                   placeholder="면적" aria-describedby="landHelp" />
            <select id="land-unit" name="land_unit" aria-label="면적 단위">
              <option value="ha">ha(헥타르)</option>
              <option value="m2">m²(제곱미터)</option>
              <option value="pyeong">평</option>
            </select>
          </div>
          <p id="landHelp" class="hint">소수점 입력 가능. 예: 0.66ha ≈ 2,000평</p>
        </div>

        <!-- 3. 가용가능 인력 -->
        <div class="field">
          <label for="workforce" class="label">가용가능 인력(명) <span class="req">*</span></label>
          <input id="workforce" name="workforce" type="number" min="0" step="1" required placeholder="예: 3" />
        </div>

        <!-- 4. 자본금 -->
        <div class="field">
          <label class="label">자본금 <span class="req">*</span></label>
          <div class="field__row">
            <input id="capital" name="capital" type="number" min="0" step="100000" required
                   placeholder="금액" aria-describedby="capitalHelp" />
            <select id="capital-unit" name="capital_unit" aria-label="자본금 단위">
              <option value="KRW">KRW(원)</option>
              <option value="만원">만원</option>
              <option value="억원">억원</option>
            </select>
          </div>
          <p id="capitalHelp" class="hint">예: 50,000,000원 = 5,000만원</p>
        </div>

        <!-- 5. 연령 -->
        <div class="field">
          <label for="age" class="label">연령 <span class="req">*</span></label>
          <input id="age" name="age" type="number" min="15" max="100" required placeholder="예: 27" />
        </div>

        <!-- 6. 농업경험 -->
        <div class="field">
          <label for="experience" class="label">농업경험 <span class="req">*</span></label>
          <div class="field__row field__row--wrap">
            <select id="experience" name="experience" required aria-label="경력 구간">
              <option value="" selected disabled>경력 구간 선택</option>
              <option value="none">없음</option>
              <option value="1-3y">1–3년</option>
              <option value="3-5y">3–5년</option>
              <option value="5y+">5년 이상</option>
            </select>
            <input id="experience-years" name="experience_years" type="number" min="0" step="0.5"
                   placeholder="세부 경력(년, 선택)" aria-label="세부 경력 (년)" />
            <div class="checkbox">
              <input type="checkbox" id="has-cert" name="has_cert" />
              <label for="has-cert">관련 자격증 보유</label>
            </div>
          </div>
        </div>

        <!-- 7. 현재 진행중인 농사 작물 -->
        <div class="field">
          <label class="label">현재 진행중인 농사 작물</label>
          <div class="chips">
            <div class="chip-group" id="chipGroup">
              <!-- 동적 칩 렌더링 -->
            </div>
            <div class="chip-input">
              <input id="cropInput" type="text" placeholder="작물 입력 후 Enter" aria-label="작물 입력" />
              <button type="button" id="addCropBtn" class="btn btn--secondary">추가</button>
            </div>
            <div class="choices">
              <button type="button" class="choice" data-crop="쌀">쌀</button>
              <button type="button" class="choice" data-crop="고추">고추</button>
              <button type="button" class="choice" data-crop="딸기">딸기</button>
              <button type="button" class="choice" data-crop="상추">상추</button>
              <button type="button" class="choice" data-crop="사과">사과</button>
              <button type="button" class="choice" data-crop="감자">감자</button>
              <button type="button" class="choice" data-crop="양파">양파</button>
              <button type="button" class="choice" data-crop="토마토">토마토</button>
            </div>
          </div>
          <!-- 서버로 전송할 hidden 필드 -->
          <input type="hidden" id="crops" name="crops" value="" />
        </div>

        <!-- 제출 -->
        <div class="actions-bar">
          <a class="btn btn--ghost" href="main.html">취소</a>
          <button type="submit" class="btn">저장</button>
        </div>

        <!-- 폼 메시지 -->
        <div id="formMessage" class="form-message" role="status" aria-live="polite"></div>
      </form>
    </section>
  </main>

  <footer class="footer">© <span id="year"></span> 귀농 청년 에이전트</footer>

  <script>
    // 공통: 아바타/메뉴/연도
    const email = sessionStorage.getItem('userEmail') || '';
    const nameFromEmail = email ? email.split('@')[0] : '';
    const avatar = document.getElementById('avatar');
    const menu = document.getElementById('menu');
    const userEmailLabel = document.getElementById('userEmailLabel');
    document.getElementById('year').textContent = new Date().getFullYear();

    if(email){
      userEmailLabel.textContent = email;
      avatar.title = email + ' • 프로필 및 설정';
      avatar.textContent = (nameFromEmail[0] || 'U').toUpperCase();
    }

    function toggleMenu(show) {
      const isShow = show ?? !menu.classList.contains('show');
      menu.classList.toggle('show', isShow);
      avatar.setAttribute('aria-expanded', String(isShow));
    }
    avatar.addEventListener('click', () => toggleMenu());
    avatar.addEventListener('keydown', (e) => {
      if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleMenu(); }
      if(e.key === 'Escape'){ toggleMenu(false); }
    });
    document.addEventListener('click', (e) => {
      if(!menu.contains(e.target) && e.target !== avatar){ toggleMenu(false); }
    });
    document.getElementById('logoutLink').addEventListener('click', () => sessionStorage.clear());

    // 작물 칩 관리
    const chipGroup = document.getElementById('chipGroup');
    const cropsInput = document.getElementById('crops');
    const cropInput = document.getElementById('cropInput');
    const addCropBtn = document.getElementById('addCropBtn');
    const choiceButtons = document.querySelectorAll('.choice');
    let crops = [];

    function renderChips() {
      chipGroup.innerHTML = '';
      crops.forEach((c, idx) => {
        const el = document.createElement('button');
        el.type = 'button';
        el.className = 'chip';
        el.innerHTML = `${c}<span aria-hidden="true">×</span>`;
        el.title = `${c} 제거`;
        el.addEventListener('click', () => {
          crops.splice(idx, 1);
          updateCrops();
        });
        chipGroup.appendChild(el);
      });
      cropsInput.value = JSON.stringify(crops);
    }
    function updateCrops() { renderChips(); }

    function addCrop(val){
      const v = (val || '').trim();
      if(!v) return;
      if(!crops.includes(v)) {
        crops.push(v);
        updateCrops();
      }
      cropInput.value = '';
      cropInput.focus();
    }

    addCropBtn.addEventListener('click', () => addCrop(cropInput.value));
    cropInput.addEventListener('keydown', (e) => {
      if(e.key === 'Enter'){ e.preventDefault(); addCrop(cropInput.value); }
      if(e.key === 'Backspace' && !cropInput.value && crops.length){
        crops.pop(); updateCrops();
      }
    });
    choiceButtons.forEach(btn => btn.addEventListener('click', () => addCrop(btn.dataset.crop)));

    // 유효성 검사 & 제출
    const form = document.getElementById('profileForm');
    const msg = document.getElementById('formMessage');
    form.addEventListener('submit', (e) => {
      // 간단한 커스텀 검증
      const requiredIds = ['region','land-size','workforce','capital','age','experience'];
      let ok = true;
      requiredIds.forEach(id => {
        const el = document.getElementById(id);
        if(!el.checkValidity()){
          el.classList.add('invalid');
          ok = false;
        } else {
          el.classList.remove('invalid');
        }
      });

      if(!ok){
        e.preventDefault();
        msg.textContent = '필수 항목을 확인해 주세요.';
        msg.className = 'form-message form-message--error';
        return;
      }

      // 단위 보조 전처리 예시 (선택)
      // 필요 시 서버 규격에 맞춰 변환 로직 추가
      msg.textContent = '저장 중…';
      msg.className = 'form-message';
    });

    // 포커스 해제 시 에러 클래스 제거
    document.querySelectorAll('input, select').forEach(el => {
      el.addEventListener('input', () => el.classList.remove('invalid'));
      el.addEventListener('change', () => el.classList.remove('invalid'));
    });
  </script>
</body>
</html>
